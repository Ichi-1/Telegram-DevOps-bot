# Навигация

- [Описание](#описание)
- [Переменные окружения](#переменные-окружения)
- [Установка](#установка)

# Описание

Телеграм-бот, интегрированный с `Gitlab Webhook`, `Grafana WebHook` и `Portainer API`, позволяет получать различного рода уведомления. 

`server.py` предоставляет эндпоинты для обработки соответсвующих веб-хуков

На текущий момент реализованы интеграции со следующими продуктами:
- `Gitlab Webhook`. Уведомления в групповой чат о начале деплоймента в Gitlab CI и об изменении статуса данного процесса. Бот сообщит как об успешном завершении процесса, так и об ошибке, а так же предоставит отчет о сборке для быстрого перехода.
- `Grafana WebHook`. Бот по веб-хуку принимает алерты из вашего инстанса Grafana и пересылает их в групповой чат. Вместе с алертом бот предоставляет кнопку-ссылку для перевода алерта в тихий режим (mute/silence)
- `Portainer API`. Реализована health-check задача для регулярного поиска контейнеров, статус которых отличается от `running`

# Переменные окружения

DEBUG: bool = True

- `BOT_TOKEN` -  Telegram API key
- `CHAT_ID` - Чат, в который бот будет отправлять уведомления
- `HOST` - Адресс хоста бэкенда для установки веб-хука Телеграм-бота
- `PORTAINER_URL` - Адресс вашего приложения Portainer
- `PORTAINER_USER` - Имя пользователя Poratiner
- `PORTAINER_PASSWORD` - Пароль пользователя Portainer


# Установка
## Интеграция с GitLab

Создайте веб-хук в вашем Gitlab:
```
Settings -> Webhooks
```
В строке URL укажите адрес эндпоинта-обработчика `/webhooks/gitlab/deployment/` - на него будут приходить JSON'ы с описанием события, на которые подписан данный веб-хук. В качестве триггера выбираем `Deployment events`.

## Интеграция с Grafana

Необходимо добавить ссылку на обработчик веб-хука у нас на сервере:
```
Alerting -> Contact Points -> New Contact Point

```
Выбираем тип Contact Point WebHook и вставляем ссылку на наш бэкенд с эндпоинтом `/webhooks/alerts/`
